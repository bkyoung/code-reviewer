name: AI Code Review

on:
  pull_request:
    branches: [ main ]
    types: [ opened, synchronize, reopened ]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write  # Required for SARIF upload
      pull-requests: write    # Required to post PR comments

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git diff

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Build code-reviewer
        run: go build -o cr ./cmd/cr

      - name: Check for skip trigger
        id: skip-check
        run: |
          # Get the head commit message
          HEAD_COMMIT_MSG=$(git log -1 --format=%B ${{ github.event.pull_request.head.sha }})

          # Check for skip trigger in commit message, PR title, or PR description
          if ./cr check-skip \
            --commit-message "$HEAD_COMMIT_MSG" \
            --pr-title "${{ github.event.pull_request.title }}" \
            --pr-description "${{ github.event.pull_request.body }}"; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Skip trigger detected, skipping code review"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "No skip trigger found, proceeding with code review"
          fi

      - name: Run AI code review
        if: steps.skip-check.outputs.skip != 'true'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          # Compare PR branch against base branch
          # github.head_ref = source branch (e.g., feature/foo)
          # github.event.pull_request.base.ref = target branch (e.g., main)
          ./cr review branch ${{ github.head_ref }} \
            --base ${{ github.event.pull_request.base.ref }} \
            --output ./review-output \
            --post-github-review \
            --github-owner ${{ github.repository_owner }} \
            --github-repo ${{ github.event.repository.name }} \
            --pr-number ${{ github.event.pull_request.number }} \
            --commit-sha ${{ github.event.pull_request.head.sha }}

      - name: Find review files
        if: steps.skip-check.outputs.skip != 'true'
        id: find-files
        run: |
          # Debug: show what files were created
          echo "Contents of review-output directory:"
          ls -la review-output/ || echo "review-output directory does not exist"

          echo ""
          echo "Contents of subdirectories:"
          find review-output -type f -name "*.md" -o -name "*.sarif"

          if [ ! -d "review-output" ]; then
            echo "Error: review-output directory was not created"
            exit 1
          fi

          # Find merged markdown file (pattern: {repo}_{branch}_merged_{timestamp}.md)
          MARKDOWN_FILE=$(find review-output -maxdepth 1 -name "*_merged_*.md" | head -1)

          # Find SARIF files (could be in subdirectory or at root)
          SARIF_FILE=$(find review-output -name "*.sarif" | head -1)

          if [ -z "$MARKDOWN_FILE" ]; then
            echo "Error: Could not find merged markdown file"
            echo "Expected pattern: review-output/*_merged_*.md"
            exit 1
          fi

          if [ -z "$SARIF_FILE" ]; then
            echo "Error: Could not find SARIF file"
            echo "Expected: *.sarif somewhere in review-output/"
            exit 1
          fi

          echo "markdown_file=$MARKDOWN_FILE" >> $GITHUB_OUTPUT
          echo "sarif_file=$SARIF_FILE" >> $GITHUB_OUTPUT

          echo "Found markdown: $MARKDOWN_FILE"
          echo "Found SARIF: $SARIF_FILE"

      - name: Upload SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v4
        if: steps.skip-check.outputs.skip != 'true'
        continue-on-error: true  # Don't fail workflow if SARIF is invalid
        with:
          sarif_file: ${{ steps.find-files.outputs.sarif_file }}
          category: ai-code-review

      - name: Upload review artifacts
        uses: actions/upload-artifact@v4
        if: steps.skip-check.outputs.skip != 'true'
        with:
          name: code-review-results
          path: review-output/
          retention-days: 30
